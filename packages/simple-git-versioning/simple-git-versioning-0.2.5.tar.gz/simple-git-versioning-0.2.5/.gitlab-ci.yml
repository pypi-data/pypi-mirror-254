# SPDX-License-Identifier: MIT

stages:
  - cache
  - static-analysis
  - build
  - test
  - release

################################################################################
#                                   DEFAULTS                                   #
################################################################################

variables:
  XDG_CACHE_HOME: $CI_PROJECT_DIR/.cache

default:
  image: python:3.11
  cache: &cache
    key:
      files:
        - pdm.lock
    paths:
      - .cache/pip
      - .cache/pdm
    policy: pull
  before_script:
    - python --version
    - pip install pdm

################################################################################
#                                    CACHE                                     #
################################################################################

update-cache:
  stage: cache
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != 'schedule')
      changes:
        paths:
          - pdm.lock
  cache:
    <<: *cache
    policy: pull-push
  script:
    - pdm install --no-self

################################################################################
#                               STATIC-ANALYSIS                                #
################################################################################

static-analysis:
  stage: static-analysis
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - pdm install --no-self
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - git rebase -x 'pdm run pre-commit run --show-diff-on-failure --from-ref HEAD^ --to-ref HEAD' origin/"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

################################################################################
#                                    BUILD                                     #
################################################################################

build-each:
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - pip install build
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - git rebase -x 'python -m build' origin/"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

################################################################################
#                                     TEST                                     #
################################################################################

pytest:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
    - pdm install --no-self
    - git fetch origin "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - git rebase -x 'pdm run pytest --cov-report=xml --junit-xml=unit-test-report.xml' origin/"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: unit-test-report.xml

################################################################################
#                                   RELEASE                                    #
################################################################################

tag:
  stage: release
  interruptible: false
  resource_group: tagging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != 'schedule'
  script:
    - pdm install --no-self
    - version=$(pdm run python -m versioning.pep440)
    - git config user.email "$GITLAB_USER_EMAIL"
    - git config user.name "$GITLAB_USER_NAME"
    - git tag -a "$version" -m "version $version"
    - git push --tag "$CI_SERVER_PROTOCOL://oauth2:$TAG_TOKEN@$CI_SERVER_HOST:$CI_SERVER_PORT/$CI_PROJECT_PATH"

publish:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
  script:
    - pip install build
    - python -m build
    - pdm publish --no-build --username "$PYPI_USERNAME" --password "$PYPI_PASSWORD"
  artifacts:
    name: dist
    paths:
      - ./dist
    expire_in: 1 week
