<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quick start guide &mdash; cg-django-uaa 2.1.4 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Authentication backends" href="backends.html" />
    <link rel="prev" title="Welcome to cg-django-uaa’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> cg-django-uaa
          </a>
              <div class="version">
                2.1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quick start guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#required-settings">Required settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optional-settings">Optional settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-urls">Setting up URLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixing-admin-login">Fixing admin login</a></li>
<li class="toctree-l2"><a class="reference internal" href="#required-templates">Required templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-fake-cloud-gov-server">Using the fake cloud.gov server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backends.html">Authentication backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorators.html">Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developing cg-django-uaa</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change log</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">cg-django-uaa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Quick start guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/quickstart.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="quick-start-guide">
<h1>Quick start guide<a class="headerlink" href="#quick-start-guide" title="Permalink to this heading">¶</a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h2>
<p>You will need Python 3.5 or above, and Django 2.2 or above.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re on an older version of Django you can pin to version 1.3.0.
<strong>Note that 1.3.0 is unmaintained</strong>, and you should upgrade
to Django 2.2 for continued support.</p>
</div>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h2>
<p>To install cg-django-uaa, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">cg</span><span class="o">-</span><span class="n">django</span><span class="o">-</span><span class="n">uaa</span>
</pre></div>
</div>
</section>
<section id="required-settings">
<h2>Required settings<a class="headerlink" href="#required-settings" title="Permalink to this heading">¶</a></h2>
<p>Begin by adding the following setting to your Django settings file:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">UAA_CLIENT_ID</span></code></dt><dd><p>This is your app’s client ID for cloud.gov UAA.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">UAA_CLIENT_SECRET</span></code></dt><dd><p>This is your app’s client secret for cloud.gov UAA.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">UAA_AUTH_URL</span></code></dt><dd><p>This is the URL for the authorize endpoint for cloud.gov, e.g.
<code class="docutils literal notranslate"><span class="pre">https://login.fr.cloud.gov/oauth/authorize</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">UAA_TOKEN_URL</span></code></dt><dd><p>This is the URL for the token endpoint for cloud.gov, e.g.
<code class="docutils literal notranslate"><span class="pre">https://uaa.fr.cloud.gov/oauth/token</span></code>. Note that it may
be at an entirely different domain from the authorize endpoint.</p>
</dd>
</dl>
<p>For information about getting a client ID and secret, see the <a class="reference external" href="https://cloud.gov/docs/services/cloud-gov-identity-provider/">cloud.gov
docs</a>.</p>
<p>Also make sure you add <code class="docutils literal notranslate"><span class="pre">'uaa_client.authentication.UaaBackend'</span></code> to
your <code class="docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code> setting.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The default authentication backend will only allow users with existing
models in your database to log in, which means that you’ll probably
need to manually create users through Django’s admin UI or via
<code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">createsuperuser</span></code>.</p>
<p>To override this default behavior, you can set <code class="docutils literal notranslate"><span class="pre">UAA_APPROVED_DOMAINS</span></code> to
create users for specific email <a class="reference internal" href="#domains">domains</a>. For more advanced cases, you may
subclass <a class="reference internal" href="backends.html#uaa_client.authentication.UaaBackend" title="uaa_client.authentication.UaaBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">uaa_client.authentication.UaaBackend</span></code></a>.</p>
</div>
<p>You will likely want to set <code class="docutils literal notranslate"><span class="pre">LOGIN_URL</span></code> to <code class="docutils literal notranslate"><span class="pre">'uaa_client:login'</span></code>, so
that any views which require login will automatically be redirected
to cloud.gov-based login.</p>
<p>You’ll also need to have <code class="docutils literal notranslate"><span class="pre">django.contrib.auth</span></code> and <code class="docutils literal notranslate"><span class="pre">uaa_client</span></code> in your
<code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> setting.</p>
<p>Finally, you will also need to add
<code class="docutils literal notranslate"><span class="pre">uaa_client.middleware.UaaRefreshMiddleware</span></code> to your <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code>
setting (or <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code> if you’re on Django 1.8 or 1.9). It needs
to be placed after Django’s session and authentication
middleware, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;uaa_client.middleware.UaaRefreshMiddleware&#39;</span><span class="p">,</span>
    <span class="c1"># ...</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="optional-settings">
<h2>Optional settings<a class="headerlink" href="#optional-settings" title="Permalink to this heading">¶</a></h2>
<p id="domains">By default, users must be created manually before they can authenticate. If
you’d like, you can approve certain domains to create users if they do not
already exist:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">UAA_APPROVED_DOMAINS</span></code></dt><dd><p>This is an array of domains for which all emails should be able to log in
to the site. If a user authenticates from one of the domains but a user
account doesn’t exist, the backend will create one and log the new user in.</p>
</dd>
</dl>
</section>
<section id="setting-up-urls">
<h2>Setting up URLs<a class="headerlink" href="#setting-up-urls" title="Permalink to this heading">¶</a></h2>
<p>You will want to add the following to your Django project’s URLconf.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Other URL patterns ...</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^auth/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;uaa_client.urls&#39;</span><span class="p">)),</span>
    <span class="c1"># More URL patterns ...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>If you are using Django 1.8, you will need to additionally pass a
<code class="docutils literal notranslate"><span class="pre">namespace=&quot;uaa_client&quot;</span></code> keyword argument to <code class="docutils literal notranslate"><span class="pre">include()</span></code>.</p>
</section>
<section id="fixing-admin-login">
<h2>Fixing admin login<a class="headerlink" href="#fixing-admin-login" title="Permalink to this heading">¶</a></h2>
<p>If you’re using Django’s admin UI, you’ll also want to configure it to
delegate to UAA instead of asking the user for their username and
password.  This can most easily be done by using the
<a class="reference internal" href="decorators.html#uaa_client.decorators.staff_login_required" title="uaa_client.decorators.staff_login_required"><code class="xref py py-func docutils literal notranslate"><span class="pre">uaa_client.decorators.staff_login_required()</span></code></a> decorator in your
URLconf:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">uaa_client.decorators</span> <span class="kn">import</span> <span class="n">staff_login_required</span>

<span class="c1"># Wrap the admin site login with our staff_login_required decorator,</span>
<span class="c1"># which will raise a PermissionDenied exception if a logged-in, but</span>
<span class="c1"># non-staff user attempts to access the login page.</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="n">staff_login_required</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">login</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Other URL patterns ...</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="c1"># More URL patterns ...</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="required-templates">
<h2>Required templates<a class="headerlink" href="#required-templates" title="Permalink to this heading">¶</a></h2>
<p>You will also need to create at least one template to use cg-django-uaa.</p>
<p>All of these are rendered using a <code class="docutils literal notranslate"><span class="pre">RequestContext</span></code> and so will also
receive any additional variables provided by <a class="reference external" href="https://docs.djangoproject.com/en/stable/ref/templates/api/">context processors</a>.</p>
<p><strong>uaa_client/login_error.html</strong></p>
<p>Used to show that the user has encountered some sort of error
when trying to authenticate with cloud.gov, or when trying to associate
a cloud.gov user with a Django user.  The context contains
a single variable, <code class="docutils literal notranslate"><span class="pre">error_code</span></code>, which can have a variety of
string values, including:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">'authenticate_failed'</span></code></dt><dd><p>This means that the underlying call to
<a class="reference external" href="https://docs.djangoproject.com/en/3.2/topics/auth/default/#django.contrib.auth.authenticate" title="(in Django v3.2)"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.contrib.auth.authenticate()</span></code></a> returned <code class="docutils literal notranslate"><span class="pre">None</span></code> instead of
a user. The actual reasons for the failure depend on the
<a class="reference internal" href="backends.html#uaa_client.authentication.UaaBackend" title="uaa_client.authentication.UaaBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">uaa_client.authentication.UaaBackend</span></code></a> your project is
configured to use; it could mean, for instance, that the OAuth2
code passed back from the cloud.gov’s authorize endpoint was invalid,
or there exists no user model with an email address corresponding
to the user who just logged in via cloud.gov.</p>
<p>You may learn more about why authentication failed by enabling
logging output for the <code class="docutils literal notranslate"><span class="pre">uaa_client</span></code> logger at the <code class="docutils literal notranslate"><span class="pre">INFO</span></code> level. While
configuring logging is outside of the scope of this guide, you may
refer to the <a class="reference external" href="https://github.com/cloud-gov/cg-django-uaa/blob/main/example/example/settings.py">example project’s settings</a>
for an example.</p>
</dd>
</dl>
<p>The other error codes generally refer to mishaps in the OAuth2 protocol
and can be discovered by examining the <code class="docutils literal notranslate"><span class="pre">uaa_client.views</span></code> module.</p>
</section>
<section id="using-the-fake-cloud-gov-server">
<span id="fakeauth"></span><h2>Using the fake cloud.gov server<a class="headerlink" href="#using-the-fake-cloud-gov-server" title="Permalink to this heading">¶</a></h2>
<p>It is possible to use a fake UAA provider for development purposes.
This allows developers to simply enter any email address and
automatically be logged-in as that user.</p>
<img alt="_images/fake-cloud-gov.png" src="_images/fake-cloud-gov.png" />
<p>To enable this functionality, set the <code class="docutils literal notranslate"><span class="pre">UAA_AUTH_URL</span></code> and
<code class="docutils literal notranslate"><span class="pre">UAA_TOKEN_URL</span></code> settings to <code class="docutils literal notranslate"><span class="pre">'fake:'</span></code>.</p>
<p>As this feature would clearly be a security hazard if used in
production, it is <em>only</em> available when <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>Note also that the fake server won’t work properly if the web
server hosting your Django project can’t handle more than one
request at a time. This generally shouldn’t be a problem, since
<code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">runserver</span></code> doesn’t have this limitation. If you’re using
gunicorn to serve your app in <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> mode, though, you may want to
make sure that your <code class="docutils literal notranslate"><span class="pre">WEB_CONCURRENCY</span></code> environment variable is
set to a value greater than 1.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to cg-django-uaa’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="backends.html" class="btn btn-neutral float-right" title="Authentication backends" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, cloud.gov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>